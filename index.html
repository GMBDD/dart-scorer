<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Darts Scoring</title>
<style>
  :root{
    --bg:#0f0f12; --card:#17171c; --text:#f2f2f2; --muted:#a7a7b0; --line:#2a2a33;
    --btn:#121218; --btn2:#1c1c24; --accent:#3a3a44; --ok:#bfffc0; --bad:#ffb3b3;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{
    padding:12px;border-bottom:1px solid var(--line);
    display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;
    background:var(--bg);position:sticky;top:0;z-index:5;
  }
  header strong{font-size:16px}
  .ver{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:3px 8px;border-radius:999px}
  button,select,input{
    padding:10px 14px;font-size:16px;border-radius:12px;border:1px solid var(--line);
    background:var(--btn);color:var(--text);
  }
  button{cursor:pointer}
  button:disabled{opacity:.45;cursor:default}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  .grid{display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .rowLeft{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:3px 8px;border-radius:999px}
  .hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px}

  /* Setup */
  .names{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .names input{width:180px;text-align:left}

  /* Scoring */
  .scoreTop{
    max-height:220px; overflow:auto; border-radius:14px; border:1px solid var(--line);
    background:#101016; padding:8px;
  }
  .playerItem{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:10px;border:1px solid var(--line);border-radius:12px;margin-bottom:8px;
    background:#0f0f14;
  }
  .playerItem.active{outline:2px solid var(--accent)}
  .playerItem.win{opacity:.65}
  .pName{font-weight:900}
  .pMeta{font-size:12px;color:var(--muted);margin-top:2px}
  .pScore{font-size:28px;font-weight:950;min-width:70px;text-align:right}

  .bigScore{font-size:48px;font-weight:950;text-align:center;margin:14px 0 6px}
  .dartRow{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0}
  .dartBox{
    min-width:110px;padding:10px;border-radius:14px;border:1px solid var(--line);
    background:#0f0f14;text-align:center;font-weight:900
  }
  .dartBox small{display:block;color:var(--muted);font-weight:400;margin-top:2px}
  .msg{min-height:18px;font-size:13px;color:var(--muted);text-align:center}
  .msg.ok{color:var(--ok)}
  .msg.bad{color:var(--bad)}

  .modes{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0}
  .modeBtn{background:var(--btn2)}
  .modeBtn.active{outline:2px solid var(--accent)}

  .nums{display:grid;gap:8px;grid-template-columns:repeat(5,1fr);max-width:520px;margin:0 auto 10px}
  .nums button{padding:12px 0}
  .specials{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:10px}
  .actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
  .tiny{font-size:12px;padding:8px 10px}

  @media (max-width: 980px){
    .nums{grid-template-columns:repeat(4,1fr)}
    .dartBox{min-width:90px}
  }

  .hidden{display:none !important;}
</style>
</head>
<body>

<header>
  <strong>üéØ Darts Scoring</strong>
  <span class="ver">Build: 2026-02-17 D</span>

  <button id="toSetupBtn" class="hidden">‚öô Setup</button>
  <button id="toGameBtn" class="hidden">üéØ Spiel</button>
</header>

<!-- ===== SETUP SCREEN ===== -->
<section id="setupScreen" class="wrap">
  <div class="grid">
    <div class="card">
      <div class="row">
        <div class="rowLeft">
          <div style="font-weight:950">Setup</div>
          <span class="pill">erst konfigurieren, dann scoring</span>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="rowLeft">
          <span>Start:</span>
          <select id="startScore">
            <option value="301" selected>301</option>
            <option value="501">501</option>
            <option value="701">701</option>
            <option value="1001">1001</option>
          </select>

          <span>Spieler:</span>
          <select id="playerCount">
            <option>1</option><option selected>2</option><option>3</option>
            <option>4</option><option>5</option><option>6</option>
          </select>

          <span>IN:</span>
          <select id="doubleIn">
            <option value="false" selected>AUS</option>
            <option value="true">AN</option>
          </select>

          <span>OUT:</span>
          <select id="outMode">
            <option value="straight" selected>AUS</option>
            <option value="double">AN</option>
          </select>

          <span>Auto-OK:</span>
          <select id="autoOk">
            <option value="true" selected>AN</option>
            <option value="false">AUS</option>
          </select>
        </div>

        <div class="rowLeft">
          <button id="randomStarterBtn">üé≤ Startspieler</button>
          <span class="pill" id="starterInfo">Startspieler: automatisch 1</span>
        </div>
      </div>

      <div style="margin-top:12px;font-weight:900">Spielernamen</div>
      <div id="nameInputs" class="names"></div>

      <div class="hint">
        Tipp: Namen eingeben ‚Üí ‚ÄûSpiel starten‚Äú. Danach bist du im Scoring-Screen ohne Overlap.
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <button id="startGameBtn">Spiel starten</button>
      </div>
    </div>
  </div>
</section>

<!-- ===== GAME SCREEN ===== -->
<section id="gameScreen" class="wrap hidden">
  <div class="grid">
    <div class="card">
      <div class="row">
        <div class="rowLeft">
          <div style="font-weight:950">√úbersicht</div>
          <span class="pill" id="rulesPill"></span>
        </div>
        <div class="rowLeft">
          <button id="undoBtn">‚¨Ö Undo</button>
          <button id="newBtn">Neues Spiel</button>
        </div>
      </div>

      <div id="scoreTop" class="scoreTop" style="margin-top:10px"></div>
      <div class="hint">Aktiver Spieler ist markiert. Gewinne werden angezeigt.</div>
    </div>

    <div class="card">
      <div class="row">
        <div class="rowLeft">
          <div class="pill">Eingabe</div>
          <div style="font-weight:950">Aktuell: <span id="currentName">‚Äî</span></div>
        </div>
        <div class="rowLeft">
          <span class="pill" id="diState">‚Äî</span>
        </div>
      </div>

      <div class="bigScore" id="currentScore">‚Äî</div>

      <div class="dartRow">
        <div class="dartBox" id="d0">‚Äî<small>&nbsp;</small></div>
        <div class="dartBox" id="d1">‚Äî<small>&nbsp;</small></div>
        <div class="dartBox" id="d2">‚Äî<small>&nbsp;</small></div>
      </div>

      <div id="msg" class="msg">&nbsp;</div>

      <div class="modes">
        <button class="modeBtn" id="mS" type="button">Single</button>
        <button class="modeBtn" id="mD" type="button">Double</button>
        <button class="modeBtn" id="mT" type="button">Triple</button>
        <span class="pill" id="modeInfo">Modus: Single ¬∑ Dart 1/3</span>
      </div>

      <div class="nums" id="nums"></div>

      <div class="specials">
        <button id="b25" type="button">25</button>
        <button id="bBull" type="button">BULL</button>
        <button id="bMiss" type="button">MISS</button>
      </div>

      <div class="actions">
        <button class="tiny" id="undoDartBtn" type="button">‚Üê Dart zur√ºck</button>
        <button class="tiny" id="clearBtn" type="button">C</button>
        <button id="okBtn" type="button">OK</button>
      </div>

      <div class="hint">Modus w√§hlen ‚Üí Zahl klicken. <b>Nach jeder Eingabe springt es zur√ºck auf Single.</b></div>
    </div>
  </div>
</section>

<script>
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=> (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function clone(obj){
    if (typeof structuredClone === "function") return structuredClone(obj);
    return JSON.parse(JSON.stringify(obj));
  }

  // ===== State =====
  let setup = {
    startScore: 301,
    playerCount: 2,
    doubleIn: false,
    outMode: "straight",
    autoOk: true,
    names: ["Spieler 1","Spieler 2"],
    starter: 0
  };

  let game = {
    players: [],
    current: 0,
    mode: "S",
    darts: [null,null,null],
    dartIdx: 0,
    banner: "",
    history: []
  };

  const HISTORY_LIMIT = 150;

  function newPlayer(name){
    return {
      name,
      score: setup.startScore,
      opened: !setup.doubleIn,
      won: false,
      msg: ""
    };
  }

  function snapshot(){
    return {
      setup: clone(setup),
      game: {
        players: clone(game.players),
        current: game.current,
        mode: game.mode,
        darts: clone(game.darts),
        dartIdx: game.dartIdx,
        banner: game.banner
      }
    };
  }
  function saveState(){
    game.history.push(snapshot());
    if (game.history.length > HISTORY_LIMIT) game.history.shift();
  }
  function undo(){
    if(!game.history.length) return;
    const snap = game.history.pop();
    setup = clone(snap.setup);
    Object.assign(game, clone(snap.game));
    renderAll();
  }

  // ===== Screen switching =====
  function showSetup(){
    $("setupScreen").classList.remove("hidden");
    $("gameScreen").classList.add("hidden");
    $("toSetupBtn").classList.add("hidden");
    $("toGameBtn").classList.add("hidden");
  }
  function showGame(){
    $("setupScreen").classList.add("hidden");
    $("gameScreen").classList.remove("hidden");
    $("toSetupBtn").classList.remove("hidden");
    $("toGameBtn").classList.add("hidden");
  }

  $("toSetupBtn").addEventListener("click", ()=>{
    if(confirm("Zum Setup zur√ºck? (Spielstand bleibt erhalten)")){
      $("toGameBtn").classList.remove("hidden");
      showSetup();
      renderSetup();
    }
  });
  $("toGameBtn").addEventListener("click", ()=>{
    showGame();
    renderAll();
  });

  // ===== Setup UI =====
  function renderSetup(){
    $("startScore").value = String(setup.startScore);
    $("playerCount").value = String(setup.playerCount);
    $("doubleIn").value = String(setup.doubleIn);
    $("outMode").value = setup.outMode;
    $("autoOk").value = String(setup.autoOk);

    // Names
    const wrap = $("nameInputs");
    wrap.innerHTML = "";
    for(let i=0;i<setup.playerCount;i++){
      const inp = document.createElement("input");
      inp.type="text";
      inp.value = setup.names[i] && !setup.names[i].startsWith("Spieler ") ? setup.names[i] : "";
      inp.placeholder = `Spieler ${i+1}`;
      inp.addEventListener("input", ()=>{
        setup.names[i] = inp.value.trim() ? inp.value.trim() : `Spieler ${i+1}`;
      });
      wrap.appendChild(inp);
      if(!setup.names[i]) setup.names[i] = `Spieler ${i+1}`;
    }

    $("starterInfo").textContent = `Startspieler: ${setup.starter+1}`;
  }

  function readSetupFromControls(){
    setup.startScore = parseInt($("startScore").value,10);
    setup.playerCount = parseInt($("playerCount").value,10);
    setup.doubleIn = $("doubleIn").value==="true";
    setup.outMode = $("outMode").value;
    setup.autoOk = $("autoOk").value==="true";

    // ensure names array size
    const names = [];
    for(let i=0;i<setup.playerCount;i++){
      names.push(setup.names[i] ? setup.names[i] : `Spieler ${i+1}`);
    }
    setup.names = names;

    // starter valid
    if(setup.starter >= setup.playerCount) setup.starter = 0;
  }

  $("playerCount").addEventListener("change", ()=>{
    readSetupFromControls();
    renderSetup();
  });
  $("startScore").addEventListener("change", ()=>{ readSetupFromControls(); renderSetup(); });
  $("doubleIn").addEventListener("change", ()=>{ readSetupFromControls(); renderSetup(); });
  $("outMode").addEventListener("change", ()=>{ readSetupFromControls(); renderSetup(); });
  $("autoOk").addEventListener("change", ()=>{ readSetupFromControls(); renderSetup(); });

  $("randomStarterBtn").addEventListener("click", ()=>{
    readSetupFromControls();
    setup.starter = Math.floor(Math.random()*setup.playerCount);
    $("starterInfo").textContent = `Startspieler: ${setup.starter+1}`;
  });

  // ===== Start Game =====
  function startNewGame(){
    readSetupFromControls();
    game.players = [];
    for(let i=0;i<setup.playerCount;i++){
      game.players.push(newPlayer(setup.names[i] || `Spieler ${i+1}`));
    }
    game.current = setup.starter;
    game.mode = "S";
    game.darts = [null,null,null];
    game.dartIdx = 0;
    game.banner = "";
    game.history = [];
    showGame();
    renderAll();
  }

  $("startGameBtn").addEventListener("click", startNewGame);
  $("newBtn").addEventListener("click", ()=>{
    if(confirm("Neues Spiel starten? (aktueller Stand geht verloren)")){
      showSetup();
      renderSetup();
    }
  });

  // ===== Scoring Logic =====
  function ensureActive(){
    const p = game.players[game.current];
    return p && !p.won;
  }
  function resetTurn(){
    game.mode="S";
    game.darts=[null,null,null];
    game.dartIdx=0;
  }
  function nextPlayer(){
    let tries=0;
    do{
      game.current = (game.current+1) % game.players.length;
      tries++;
      if(tries > game.players.length+1) break;
    }while(game.players[game.current].won);
    resetTurn();
  }

  function setMode(m){
    if(!ensureActive()) return;
    saveState();
    game.mode = m;
    renderMode();
    renderHeader();
  }

  function pushDart(obj){
    if(!ensureActive()) return;
    if(game.dartIdx>2) return;

    saveState();
    game.darts[game.dartIdx] = obj;
    game.dartIdx++;

    // reset to single after each input
    game.mode = "S";

    renderInput();
    renderMode();
    renderHeader();

    if(setup.autoOk && game.dartIdx===3){
      setTimeout(()=>{ if(game.dartIdx===3) submitTurn(); }, 120);
    }
  }

  function pickNumber(n){
    let points=n, label=`S${n}`, isDouble=false, isTriple=false;
    if(game.mode==="D"){ points=2*n; label=`D${n}`; isDouble=true; }
    if(game.mode==="T"){ points=3*n; label=`T${n}`; isTriple=true; }
    pushDart({label, points, isDouble, isTriple});
  }

  function pickSpecial(type){
    if(type==="MISS") return pushDart({label:"0", points:0, isDouble:false, isTriple:false});
    if(type==="25")   return pushDart({label:"25", points:25, isDouble:false, isTriple:false});
    if(type==="BULL") return pushDart({label:"BULL", points:50, isDouble:true, isTriple:false});
  }

  function undoDart(){
    if(!ensureActive()) return;
    if(game.dartIdx===0) return;
    saveState();
    game.dartIdx--;
    game.darts[game.dartIdx]=null;
    renderInput();
    renderHeader();
  }

  function clearTurn(){
    if(!ensureActive()) return;
    saveState();
    resetTurn();
    renderInput(); renderMode(); renderHeader();
  }

  function submitTurn(){
    if(!ensureActive()) return;
    saveState();

    const p = game.players[game.current];
    p.msg="";

    // fill missing
    const turn = game.darts.map(d=>d ?? ({label:"0", points:0, isDouble:false, isTriple:false}));
    const effective = clone(turn);

    // Double-IN: first counting dart must be a double
    if(setup.doubleIn && !p.opened){
      const idx = effective.findIndex(d=>d.isDouble && d.points>0);
      if(idx===-1){
        p.msg="Kein IN ‚Üí 0";
        nextPlayer();
        renderAll();
        return;
      }
      p.opened = true;
      for(let k=0;k<idx;k++) effective[k]={label:"0", points:0, isDouble:false, isTriple:false};
    }

    const total = effective[0].points + effective[1].points + effective[2].points;
    const newScore = p.score - total;

    // Bust
    if(newScore < 0 || (setup.outMode==="double" && newScore===1)){
      p.msg="BUST";
      nextPlayer();
      renderAll();
      return;
    }

    // Checkout
    if(newScore===0){
      if(setup.outMode==="double"){
        const last = effective[2];
        if(!(last.isDouble && last.points>0)){
          p.msg="BUST (kein Double-Out)";
          nextPlayer();
          renderAll();
          return;
        }
      }
      p.score=0;
      p.won=true;
      p.msg="WIN ‚úÖ";
      nextPlayer();
      renderAll();
      return;
    }

    p.score = newScore;
    p.msg = total>0 ? `‚àí${total}` : "";
    nextPlayer();
    renderAll();
  }

  // ===== Render Scoring =====
  function renderRules(){
    const inTxt = setup.doubleIn ? "IN AN" : "IN AUS";
    const outTxt = (setup.outMode==="double") ? "OUT AN" : "OUT AUS";
    $("rulesPill").textContent = `${setup.startScore} ¬∑ ${inTxt} ¬∑ ${outTxt} ¬∑ Auto-OK ${setup.autoOk ? "AN":"AUS"}`;
  }

  function renderScoreTop(){
    const wrap = $("scoreTop");
    wrap.innerHTML = "";
    game.players.forEach((p,i)=>{
      const div = document.createElement("div");
      div.className = "playerItem" + (i===game.current && !p.won ? " active":"") + (p.won ? " win":"");
      const inState = setup.doubleIn ? (p.opened ? "open" : "closed") : "aus";
      div.innerHTML = `
        <div style="min-width:0">
          <div class="pName">${esc(p.name)} ${p.won?"‚úÖ":""}</div>
          <div class="pMeta">IN: ${inState} ¬∑ ${p.msg ? esc(p.msg) : "&nbsp;"}</div>
        </div>
        <div class="pScore">${p.score}</div>
      `;
      wrap.appendChild(div);
    });
  }

  function renderHeader(){
    const p = game.players[game.current];
    $("currentName").textContent = p ? p.name : "‚Äî";
    $("currentScore").textContent = p ? p.score : "‚Äî";
    const inTxt = setup.doubleIn ? (p.opened ? "IN: open" : "IN: closed") : "IN: aus";
    const outTxt = (setup.outMode==="double") ? "OUT: double" : "OUT: straight";
    $("diState").textContent = `${inTxt} ¬∑ ${outTxt}`;
    $("modeInfo").textContent =
      `Modus: ${game.mode==="S"?"Single":game.mode==="D"?"Double":"Triple"} ¬∑ Dart ${Math.min(game.dartIdx+1,3)}/3`;
  }

  function renderInput(){
    const box = (el, obj)=>{
      if(!obj){ el.innerHTML = `‚Äî<small>&nbsp;</small>`; return; }
      el.innerHTML = `${esc(obj.label)}<small>${obj.points} pts</small>`;
    };
    box($("d0"), game.darts[0]);
    box($("d1"), game.darts[1]);
    box($("d2"), game.darts[2]);

    const p = game.players[game.current];
    const msg = $("msg");
    msg.className = "msg";
    const m = p?.msg || "";
    if(m.includes("WIN")) msg.classList.add("ok");
    if(m.includes("BUST")) msg.classList.add("bad");
    msg.textContent = m ? m : " ";

    // disable if someone won and only winners left (edge)
    const disable = !ensureActive();
    document.querySelectorAll("#gameScreen button").forEach(btn=>{
      if(btn.id==="newBtn") return;
      btn.disabled = disable;
    });
  }

  function renderMode(){
    $("mS").classList.toggle("active", game.mode==="S");
    $("mD").classList.toggle("active", game.mode==="D");
    $("mT").classList.toggle("active", game.mode==="T");
  }

  function renderAll(){
    renderRules();
    renderScoreTop();
    renderHeader();
    renderInput();
    renderMode();
  }

  // buttons
  $("undoBtn").addEventListener("click", undo);
  $("undoDartBtn").addEventListener("click", undoDart);
  $("clearBtn").addEventListener("click", clearTurn);
  $("okBtn").addEventListener("click", submitTurn);

  $("mS").addEventListener("click", ()=>setMode("S"));
  $("mD").addEventListener("click", ()=>setMode("D"));
  $("mT").addEventListener("click", ()=>setMode("T"));

  $("b25").addEventListener("click", ()=>pickSpecial("25"));
  $("bBull").addEventListener("click", ()=>pickSpecial("BULL"));
  $("bMiss").addEventListener("click", ()=>pickSpecial("MISS"));

  // build numbers 1-20 once
  const nums = $("nums");
  for(let n=1;n<=20;n++){
    const b=document.createElement("button");
    b.textContent=String(n);
    b.addEventListener("click", ()=>pickNumber(n));
    nums.appendChild(b);
  }

  // init
  renderSetup();
  showSetup();
</script>

</body>
</html>
