<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Darts Scoring</title>

<style>
  :root{
    --bg:#0f0f12; --card:#17171c; --text:#f2f2f2; --muted:#a7a7b0; --line:#2a2a33;
    --btn:#121218; --btn2:#1c1c24; --accent:#3a3a44; --ok:#bfffc0; --bad:#ffb3b3;
  }
  *{box-sizing:border-box}
  body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
  header{
    padding:12px;border-bottom:1px solid var(--line);
    display:flex;justify-content:center;flex-wrap:wrap;gap:10px;align-items:center
  }
  header strong{font-size:16px}
  button,select,input{
    padding:10px 14px;font-size:16px;border-radius:12px;border:1px solid var(--line);
    background:var(--btn);color:var(--text);cursor:pointer
  }
  button:disabled{opacity:.45;cursor:default}
  select{padding:9px 10px}

  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px;
  }
  .banner{display:none;margin-bottom:12px}
  .banner.show{display:block}
  .banner b{font-weight:800}
  .hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px}
  .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:3px 8px;border-radius:999px;display:inline-block}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .rowLeft{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* Layout: scoreboard + keypad (Desktop) */
  .layout{
    display:grid;
    grid-template-columns: 1fr 520px;
    gap:12px;
    align-items:start;
  }

  /* Scoreboard list */
  .playerList{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .playerItem{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:10px 10px;border:1px solid var(--line);border-radius:14px;background:#101016;
  }
  .playerItem.active{outline:2px solid var(--accent)}
  .playerItem.win{opacity:.65}
  .pName{font-weight:800}
  .pMeta{color:var(--muted);font-size:12px;margin-top:2px}
  .pScore{font-size:28px;font-weight:900;min-width:70px;text-align:right}

  /* Namen (oben) */
  .nameEdit{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .nameEdit input{width:180px;text-align:left}

  /* Keypad (single) */
  .keypadTop{
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap
  }
  .bigScore{font-size:44px;font-weight:950;margin:8px 0;text-align:center}
  .dartRow{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0}
  .dartBox{
    min-width:110px;padding:10px;border-radius:14px;border:1px solid var(--line);
    background:#0f0f14;text-align:center;font-weight:900
  }
  .dartBox small{display:block;color:var(--muted);font-weight:400;margin-top:2px}
  .msg{min-height:18px;font-size:13px;color:var(--muted);text-align:center}
  .msg.ok{color:var(--ok)}
  .msg.bad{color:var(--bad)}

  .modes{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:10px}
  .modeBtn{background:var(--btn2)}
  .modeBtn.active{outline:2px solid var(--accent)}
  .nums{
    display:grid;gap:8px;grid-template-columns:repeat(5,1fr);
    max-width:520px;margin:0 auto 10px
  }
  .nums button{padding:12px 0}
  .specials{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:10px}
  .actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}

  /* Mobile fix: keypad fixed bottom + page bottom padding so nothing is hidden */
  @media (max-width: 980px){
    .layout{grid-template-columns: 1fr}

    .wrap{
      /* Platz f√ºr das fixe Keypad unten */
      padding-bottom: calc(520px + env(safe-area-inset-bottom, 0px));
    }
    .keypadCard{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      z-index: 50;
      box-shadow: 0 -10px 30px rgba(0,0,0,.35);
      max-height: 520px;
      overflow: auto;
    }
    .nums{grid-template-columns:repeat(4,1fr)}
    .dartBox{min-width:90px}
  }
</style>
</head>

<body>

<header>
  <strong>üéØ Darts Scoring</strong>

  <span>Start:</span>
  <select id="startScore">
    <option value="301" selected>301</option>
    <option value="501">501</option>
    <option value="701">701</option>
    <option value="1001">1001</option>
  </select>

  <span>Spieler:</span>
  <select id="playerCount">
    <option>1</option><option selected>2</option><option>3</option>
    <option>4</option><option>5</option><option>6</option>
  </select>

  <span>IN:</span>
  <select id="doubleIn">
    <option value="false" selected>AUS</option>
    <option value="true">AN</option>
  </select>

  <span>OUT:</span>
  <select id="outMode">
    <option value="straight" selected>AUS</option>
    <option value="double">AN</option>
  </select>

  <span>Auto-OK:</span>
  <select id="autoOk">
    <option value="true" selected>AN</option>
    <option value="false">AUS</option>
  </select>

  <button id="startBtn">Neues Spiel</button>
  <button id="randomStartBtn">üé≤ Startspieler</button>
  <button id="undoBtn">‚¨Ö Undo</button>
</header>

<div class="wrap">
  <div id="banner" class="card banner"></div>

  <!-- Namen oben -->
  <div class="card" style="margin-bottom:12px">
    <div class="row">
      <div class="rowLeft">
        <div style="font-weight:900">Spielernamen</div>
        <span class="pill">jederzeit √§nderbar</span>
      </div>
      <span id="rulesPill" class="pill"></span>
    </div>
    <div id="nameEdit" class="nameEdit"></div>
    <div class="hint">Tipp: Name leer = Standardname (‚ÄûSpieler X‚Äú).</div>
  </div>

  <div class="layout">
    <!-- Scoreboard -->
    <div class="card">
      <div class="row">
        <div class="rowLeft">
          <div style="font-weight:900">√úbersicht</div>
          <span class="pill">Aktiver Spieler ist markiert</span>
        </div>
        <span class="pill">Scores live</span>
      </div>

      <div id="playerList" class="playerList"></div>
      <div class="hint">Undo funktioniert auch nach OK & Spielerwechsel.</div>
    </div>

    <!-- Single Keypad -->
    <div class="card keypadCard">
      <div class="keypadTop">
        <div>
          <div class="pill">Eingabe-Panel (einmal)</div>
          <div style="font-weight:950;font-size:18px;margin-top:6px">
            Aktuell: <span id="currentName">‚Äî</span>
          </div>
        </div>
        <div class="pill" id="diState">‚Äî</div>
      </div>

      <div class="bigScore" id="currentScore">‚Äî</div>

      <div class="dartRow">
        <div class="dartBox" id="d0">‚Äî<small>&nbsp;</small></div>
        <div class="dartBox" id="d1">‚Äî<small>&nbsp;</small></div>
        <div class="dartBox" id="d2">‚Äî<small>&nbsp;</small></div>
      </div>

      <div id="msg" class="msg">&nbsp;</div>

      <div class="modes">
        <button class="modeBtn" id="mS">Single</button>
        <button class="modeBtn" id="mD">Double</button>
        <button class="modeBtn" id="mT">Triple</button>
        <span class="pill" id="modeInfo">Modus: Single ¬∑ Dart 1/3</span>
      </div>

      <div class="nums" id="nums"></div>

      <div class="specials">
        <button id="b25">25</button>
        <button id="bBull">BULL</button>
        <button id="bMiss">MISS</button>
      </div>

      <div class="actions">
        <button class="tiny" id="undoDartBtn">‚Üê Dart zur√ºck</button>
        <button class="tiny" id="clearBtn">C</button>
        <button id="okBtn">OK</button>
      </div>

      <div class="hint">
        Modus w√§hlen ‚Üí Zahl klicken. <b>Nach jeder Eingabe zur√ºck auf Single</b>.
      </div>
    </div>
  </div>

  <div class="hint" style="padding:0 6px 14px">
    Hinweis: Auf dem Handy ist das Keypad unten fix. Durch den extra Abstand unten wird nichts verdeckt.
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const deepCopy = (x)=>JSON.parse(JSON.stringify(x));

let state = {
  startScore: 301,
  playerCount: 2,
  doubleIn: false,
  outMode: "straight",     // "straight" (OUT AUS) oder "double" (OUT AN)
  autoOk: true,

  players: [],
  current: 0,

  mode: "S",
  darts: [null,null,null],
  dartIdx: 0,

  banner: "",
  history: []
};

function newPlayer(name){
  return {
    name,
    score: state.startScore,
    opened: !state.doubleIn,
    won: false,
    msg: "",
    stats: { darts:0, scored:0, avg3:0, s180:0, bestFinish:0 }
  };
}

function saveState(){
  state.history.push(deepCopy(state));
  if(state.history.length>300) state.history.shift();
}

function undo(){
  if(!state.history.length) return;
  state = state.history.pop();
  syncControlsFromState();
  renderAll();
}

function resetTurn(){
  state.mode="S";
  state.darts=[null,null,null];
  state.dartIdx=0;
}

function ensureActive(){
  const p = state.players[state.current];
  return p && !p.won;
}

function startGame(){
  state.startScore = parseInt($("startScore").value,10);
  state.playerCount = parseInt($("playerCount").value,10);
  state.doubleIn = $("doubleIn").value==="true";
  state.outMode = $("outMode").value;                  // straight / double
  state.autoOk = $("autoOk").value==="true";

  state.players=[];
  for(let i=0;i<state.playerCount;i++){
    state.players.push(newPlayer(`Spieler ${i+1}`));
  }

  state.current=0;
  state.banner="";
  state.history=[];
  resetTurn();
  renderAll();
}

function randomStart(){
  if(!state.players.length) return;
  saveState();
  const alive = state.players.map((p,i)=>({p,i})).filter(x=>!x.p.won);
  const pick = alive[Math.floor(Math.random()*alive.length)];
  state.current = pick.i;
  resetTurn();
  state.banner = `${state.players[state.current].name} beginnt (zuf√§llig).`;
  renderAll();
}

function syncControlsFromState(){
  $("startScore").value = String(state.startScore);
  $("playerCount").value = String(state.playerCount);
  $("doubleIn").value = String(state.doubleIn);
  $("outMode").value = state.outMode;
  $("autoOk").value = String(state.autoOk);
}

function setMode(m){
  if(!ensureActive()) return;
  saveState();
  state.mode = m;
  renderModeButtons();
  renderKeypadHeader();
}

function pushDart(obj){
  if(!ensureActive()) return;
  if(state.dartIdx>2) return;

  saveState();

  state.darts[state.dartIdx]=obj;
  state.dartIdx++;

  // nach jeder Eingabe zur√ºck auf Single
  state.mode="S";

  renderKeypad();
  renderModeButtons();
  renderKeypadHeader();

  if(state.autoOk && state.dartIdx===3){
    setTimeout(()=>{ if(state.dartIdx===3) submitTurn(); }, 120);
  }
}

function pickNumber(n){
  let mult = state.mode;
  let points=n, isDouble=false, isTriple=false, label=`S${n}`;

  if(mult==="D"){ points=2*n; isDouble=true; label=`D${n}`; }
  if(mult==="T"){ points=3*n; isTriple=true; label=`T${n}`; }

  pushDart({label, points, isDouble, isTriple, raw:{type:"number", n, mult}});
}

function pickSpecial(type){
  if(type==="MISS") return pushDart({label:"0", points:0, isDouble:false, isTriple:false, raw:{type:"miss"}});
  if(type==="25")   return pushDart({label:"25", points:25, isDouble:false, isTriple:false, raw:{type:"25"}});
  if(type==="BULL") return pushDart({label:"BULL", points:50, isDouble:true, isTriple:false, raw:{type:"bull"}});
}

function undoDart(){
  if(!ensureActive()) return;
  if(state.dartIdx===0) return;
  saveState();
  state.dartIdx--;
  state.darts[state.dartIdx]=null;
  renderKeypad();
  renderKeypadHeader();
}

function clearTurn(){
  if(!ensureActive()) return;
  saveState();
  resetTurn();
  renderKeypad();
  renderModeButtons();
  renderKeypadHeader();
}

function nextPlayer(){
  let tries=0;
  do{
    state.current = (state.current+1)%state.players.length;
    tries++;
    if(tries>state.players.length+1) break;
  }while(state.players[state.current].won);
  resetTurn();
}

function updateStats(p, turnTotal){
  p.stats.darts += 3;
  p.stats.scored += turnTotal;
  p.stats.avg3 = p.stats.darts ? (p.stats.scored / p.stats.darts) * 3 : 0;
  if(turnTotal===180) p.stats.s180 += 1;
}

function submitTurn(){
  if(!ensureActive()) return;
  saveState();

  const p = state.players[state.current];
  p.msg="";

  const turn = state.darts.map(d=>d ?? ({label:"0", points:0, isDouble:false, isTriple:false, raw:{type:"miss"}}));
  let effective = deepCopy(turn);

  // IN (Double-In)
  if(!p.opened && state.doubleIn){
    const idx = effective.findIndex(d=>d.isDouble && d.points>0);
    if(idx===-1){
      p.msg="Kein IN ‚Üí nichts z√§hlt";
      updateStats(p, 0);
      nextPlayer();
      renderAll();
      return;
    }
    p.opened=true;
    for(let k=0;k<idx;k++) effective[k]={label:"0", points:0, isDouble:false, isTriple:false, raw:{type:"miss"}};
  }

  const total = effective[0].points + effective[1].points + effective[2].points;
  const newScore = p.score - total;

  // Bust: unter 0 oder (Double-Out & Rest=1)
  if(newScore < 0 || (state.outMode==="double" && newScore===1)){
    p.msg="BUST";
    updateStats(p, 0);
    nextPlayer();
    renderAll();
    return;
  }

  // Checkout
  if(newScore===0){
    if(state.outMode==="double"){
      const last = effective[2];
      if(!(last.isDouble && last.points>0)){
        p.msg="BUST (kein Double-Finish)";
        updateStats(p, 0);
        nextPlayer();
        renderAll();
        return;
      }
    }

    const finish = p.score;
    p.stats.bestFinish = Math.max(p.stats.bestFinish, finish);

    p.score=0;
    p.won=true;
    p.msg="WIN ‚úÖ";
    updateStats(p, total);
    state.banner = `${p.name} gewinnt! (Finish ${finish})`;

    nextPlayer();
    renderAll();
    return;
  }

  // Normal
  p.score=newScore;
  p.msg = total>0 ? `‚àí${total}` : "";
  updateStats(p, total);

  nextPlayer();
  renderAll();
}

function renderAll(){
  renderBanner();
  renderRulesPill();
  renderNameEdit();
  renderPlayerList();
  renderKeypad();
  renderModeButtons();
  renderKeypadHeader();
}

function renderBanner(){
  const b = $("banner");
  if(!state.banner){
    b.classList.remove("show");
    b.innerHTML="";
    return;
  }
  b.classList.add("show");
  b.innerHTML = `<b>${escapeHtml(state.banner)}</b>`;
}

function renderRulesPill(){
  const outTxt = (state.outMode==="double") ? "OUT AN" : "OUT AUS";
  const inTxt  = state.doubleIn ? "IN AN" : "IN AUS";
  $("rulesPill").textContent =
    `${state.startScore} ¬∑ ${inTxt} ¬∑ ${outTxt} ¬∑ Auto-OK ${state.autoOk ? "AN" : "AUS"}`;
}

function renderPlayerList(){
  const wrap = $("playerList");
  wrap.innerHTML = "";

  state.players.forEach((p,i)=>{
    const div = document.createElement("div");
    div.className = "playerItem" + (i===state.current && !p.won ? " active" : "") + (p.won ? " win" : "");
    const inState = state.doubleIn ? (p.opened ? "open" : "closed") : "aus";
    const avg = (p.stats.avg3||0).toFixed(1);

    div.innerHTML = `
      <div style="min-width:0">
        <div class="pName">${escapeHtml(p.name)} ${p.won ? "‚úÖ" : ""}</div>
        <div class="pMeta">IN: ${inState} ¬∑ Avg: ${avg} ¬∑ 180s: ${p.stats.s180} ¬∑ Best: ${p.stats.bestFinish}</div>
        <div class="pMeta">${p.msg ? escapeHtml(p.msg) : "&nbsp;"}</div>
      </div>
      <div class="pScore">${p.score}</div>
    `;
    wrap.appendChild(div);
  });
}

function renderNameEdit(){
  const wrap = $("nameEdit");
  wrap.innerHTML = "";

  state.players.forEach((p,i)=>{
    const inp = document.createElement("input");
    inp.type="text";
    inp.value = p.name.startsWith("Spieler ") ? "" : p.name;
    inp.placeholder = p.name;
    inp.addEventListener("input", ()=>{
      p.name = inp.value.trim() ? inp.value.trim() : `Spieler ${i+1}`;
      renderPlayerList();
      renderKeypadHeader();
      if(state.banner) renderBanner();
    });
    inp.addEventListener("blur", ()=> saveState());
    wrap.appendChild(inp);
  });
}

function renderKeypadHeader(){
  const p = state.players[state.current];
  $("currentName").textContent = p ? p.name : "‚Äî";
  $("currentScore").textContent = p ? p.score : "‚Äî";

  const inTxt = state.doubleIn ? (p.opened ? "IN: open" : "IN: closed") : "IN: aus";
  const outTxt = (state.outMode==="double") ? "OUT: double" : "OUT: straight";
  $("diState").textContent = `${inTxt} ¬∑ ${outTxt}`;

  $("modeInfo").textContent =
    `Modus: ${state.mode==="S"?"Single":state.mode==="D"?"Double":"Triple"} ¬∑ Dart ${Math.min(state.dartIdx+1,3)}/3`;
}

function renderKeypad(){
  const p = state.players[state.current];
  const d = (idx)=> state.darts[idx];

  const box = (el, obj)=>{
    if(!obj){ el.innerHTML = `‚Äî<small>&nbsp;</small>`; return; }
    el.innerHTML = `${escapeHtml(obj.label)}<small>${obj.points} pts</small>`;
  };

  box($("d0"), d(0));
  box($("d1"), d(1));
  box($("d2"), d(2));

  const msg = $("msg");
  const m = p?.msg || "";
  msg.className = "msg";
  if(m.includes("WIN")) msg.classList.add("ok");
  if(m.includes("BUST")) msg.classList.add("bad");
  msg.textContent = m ? m : " ";

  const nums = $("nums");
  if(!nums.dataset.built){
    nums.dataset.built="1";
    for(let n=1;n<=20;n++){
      const b=document.createElement("button");
      b.textContent=String(n);
      b.addEventListener("click", ()=>pickNumber(n));
      nums.appendChild(b);
    }
  }

  const disable = !ensureActive();
  document.querySelectorAll(".keypadCard button").forEach(btn=> btn.disabled = disable);
}

function renderModeButtons(){
  $("mS").classList.toggle("active", state.mode==="S");
  $("mD").classList.toggle("active", state.mode==="D");
  $("mT").classList.toggle("active", state.mode==="T");
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* Wire up */
$("startBtn").addEventListener("click", startGame);
$("randomStartBtn").addEventListener("click", randomStart);
$("undoBtn").addEventListener("click", undo);

$("mS").addEventListener("click", ()=>setMode("S"));
$("mD").addEventListener("click", ()=>setMode("D"));
$("mT").addEventListener("click", ()=>setMode("T"));

$("b25").addEventListener("click", ()=>pickSpecial("25"));
$("bBull").addEventListener("click", ()=>pickSpecial("BULL"));
$("bMiss").addEventListener("click", ()=>pickSpecial("MISS"));

$("undoDartBtn").addEventListener("click", undoDart);
$("clearBtn").addEventListener("click", clearTurn);
$("okBtn").addEventListener("click", submitTurn);

// Auto-OK darf live umgeschaltet werden (ohne Neustart)
$("autoOk").addEventListener("change", ()=>{
  saveState();
  state.autoOk = $("autoOk").value==="true";
  renderRulesPill();
});

// Startwerte initial in UI setzen (falls Browser cached)
$("startScore").value = "301";
$("playerCount").value = "2";
$("doubleIn").value = "false";
$("outMode").value = "straight";
$("autoOk").value = "true";

startGame();
</script>

</body>
</html>
